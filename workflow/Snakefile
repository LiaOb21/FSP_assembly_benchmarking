# Main entrypoint of the workflow.
# Please follow the best practices:
# https://snakemake.readthedocs.io/en/stable/snakefiles/best_practices.html,
# in particular regarding the standardized folder structure mentioned there.

import glob
import os


configfile: "config/config.yml"


input_dir = config["input_dir"]
output_dir = config["output_dir"]

# Collect sample names from test_data directory
SAMPLES = [os.path.basename(d) for d in glob.glob(f"{input_dir}/*") if os.path.isdir(d)]

# Get assemblers to run from config
ASSEMBLERS = [
    assembler for assembler, enabled in config.get("assemblers", {}).items() 
    if enabled
]

# include common rule (where functions are defined)
include: "rules/common.smk"

# Conditionally include kmergenie rule only if using kmergenie mode
if config["kmer_strategy"]["mode"] == "kmergenie":
    include: "rules/kmergenie.smk"

# if spades is in ASSEMBLERS include spades rules
if "spades" in ASSEMBLERS:
    include: "rules/spades.smk"
# if megahit is in ASSEMBLERS include megahit rules
if "megahit" in ASSEMBLERS:
    include: "rules/megahit.smk"
# if abyss is in ASSEMBLERS include abyss rules
if "abyss" in ASSEMBLERS:
    include: "rules/abyss.smk"
# if sparseassembler is in ASSEMBLERS include sparseassembler rules
if "sparseassembler" in ASSEMBLERS:
    include: "rules/decompress_reads.smk"
    include: "rules/sparseassembler.smk"
# if minia is in ASSEMBLERS include minia rules
if "minia" in ASSEMBLERS:
    include: "rules/minia.smk"
# if masurca is in ASSEMBLERS include masurca rules
if "masurca" in ASSEMBLERS:
    include: "rules/masurca_config.smk"
    include: "rules/masurca.smk"

include: "rules/busco.smk"
# include quast rule
include: "rules/quast.smk"
# include fastK rule
include: "rules/fastK.smk"
# include merquryFK rule
include: "rules/merquryFK.smk"
# include select_best_assembly rule
include: "rules/select_best_assembly.smk"
# include bwa_mem2 rule
include: "rules/bwa_mem2_samtools.smk"
# include pilon rule
include: "rules/pilon.smk"
# include busco_2 rule (runs after pilon)
include: "rules/busco_2.smk"
# include merquryFK_2 rule (runs after pilon)
include: "rules/merquryFK_2.smk"
# include quast_2 rule (runs after pilon)
include: "rules/quast_2.smk"
# include bwa_mem2_samtools_2 rule (runs after pilon)
include: "rules/bwa_mem2_samtools_2.smk"
#include coverage_viz_2 rule
include: "rules/coverage_viz.smk"

# input files for rule all are defined in the common.smk file
rule all:
    input:
        get_all_inputs()
